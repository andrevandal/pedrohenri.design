---
import { YouTube } from '@astro-community/astro-embed-youtube'

type Props = {
  id: string
  poster?: string
  posterQuality?: 'max' | 'high' | 'default' | 'low'
  params?: string
  playlabel?: string
  title?: string
  autoplay?: boolean | string
}

const {
  id,
  poster,
  posterQuality,
  params,
  playlabel = 'Play',
  title,
  autoplay = false
} = Astro.props

const shouldAutoplay = autoplay === true || autoplay === 'true'
const videoId = `youtube-${id}-${crypto.randomUUID()}`

const embedParams = shouldAutoplay
  ? (() => {
      const defaults = new Map([
        ['autoplay', '1'],
        ['mute', '1'],
        ['enablejsapi', '1'],
        ['rel', '0'],
        ['playsinline', '1'],
        ['loop', '1'],
        ['controls', '0']
      ])

      params?.split('&').forEach((param) => {
        const [key, value] = param.split('=')
        if (key) defaults.set(key, value ?? '1')
      })

      return Array.from(defaults.entries())
        .map(([key, value]) => `${key}=${value}`)
        .join('&')
    })()
  : params

const extraAttrs = shouldAutoplay ? { autoload: true } : {}
---

<style>
  lite-youtube {
    max-width: unset;
  }
</style>

{
  id && (
    <div
      class='not-prose w-full'
      data-autoplay={shouldAutoplay ? 'true' : undefined}
      data-video-id={shouldAutoplay ? videoId : undefined}
    >
      <YouTube
        id={id}
        poster={poster}
        posterQuality={posterQuality}
        params={embedParams}
        playlabel={playlabel}
        title={title}
        {...extraAttrs}
      />
    </div>
  )
}

{shouldAutoplay && <script src='../../scripts/youtube-autoplay-manager.ts' />}
